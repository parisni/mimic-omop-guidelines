%% Kahn
% evaluation methods
% 1. Data Transformation
%%  Comprehensiveness, integrity, flexibility, integration, implementability 
% 2. Contributions
%% flexibility
% 3. Analytics
%% Understandability and simplicity 
The evaluation of a system and a structural model is rather difficult \cite{moody-quality} 
but we have tried to evaluate it through several axes.
Several articles have attempted to assess the quality of the CDM \cite{kahn_data_2012,omop-vs-pcornet}. 
The criteria developed by Khan and Al\cite{khan-quality}, which refer to the metrics 
Moody and Shanks \cite{moody-quality}, have been adapted for our study. 
Our study does not want to assess the quality of the CDM. But we adapt these 
criteria to assess the quality of the data transformation (table \ref{table:quality}).
Comprehensiveness, integrity, flexibility, integration, implementability 
will be discussed in this part (data transformation). 
Understandability and simplicity will be assessed in the analytical parts, in
the actual application.

%
% 1. Data Transformation
% 2. Contributions
% 3. Analytics
% 
\subsection{Data Transformation}

% General
The MIMIC to OMOP conversion was performed by two developers (a data engineer 
and an intensivist) for an estimated 500 hours. This includes ELT, git 
documentation, concept mapping, contributions and unit tests. 
ELT (with unit tests and generation of ready-to-load archives) on the subset 
of 100 patients takes five minutes and enables fast development cycles. 
On all MIMIC data, the ELT lasts 3 hours. The resulting csv archive is about
the same size as the original archive, and it is also the same once loaded in
PGSQL and indexed.

The OMOP-CDM contains 37 data tables. We populated 19 tables. 
From MIMIC, we create a standardized model called MIMIC-OMOP.


%% Unit tests
The first axe was the unit tests. During the all ETL process we created a lot 
of unit tests thanks to pgTap library. 
All are available on our github \cite{mimic-omop-website}. All the test passed.

%% Achilles evaluation            
The second axe was Achilles evaluation. Like many previous authors, 
we used the Achille software to assess data quality \cite{achilles-evaluation}. 
It is an open-source analysis software produced by OHDSI \cite{ohdsi-achilles}.
This tool is used for data characterization, data quality assessment 
(Achilles' heel) and health observation data visualization \cite{ohdsi-achilles}.
It has been common practice to perform Achilles tests and use it as a 
quality assessment in many works. Achilles Heel issued 12 errors and y warnings. 
This result is correct compared to other studies \cite{achilles-evaluation}
We believe that this tool has several limitations. It does not evaluate 
the structural change, it is difficult to understand some error messages and 
we decide to process more evaluation tests.     


All the code to create these statistics is provided on the github repository 
\cite{mimic-omop-website}.

% Please add the following required packages to your document preamble:
% \usepackage[normalem]{ulem}
% \useunder{\uline}{\ul}{}
% Please add the following required packages to your document preamble:
% \usepackage[normalem]{ulem}
% \useunder{\uline}{\ul}{}
\tiny
\begin{table*}[t]
%\tbl{Data Transformation Quality Evaluation Metrics}{%
\caption{Data Transformation Quality Evaluation Metrics}
\begin{tabular}{@{}ll@{}}\toprule
Data Model Dimension              & Descriptions                                                                                                      \\\colrule
Completeness - structural mapping & Domain coverage : coverage of sources domains that are accommodated by the standard OMOP model                    \\
Completeness - conceptual mapping & Data coverage : coverage of sources data concepts that mapped to standard OMOP concept                           \\
Integrity                         & "Meaningful data relationships and constraints that uphold th eintent of the data-s original purpose" Khan and Al \\
Flexibility                       & The ease to expand the standard model for new datatypes, concepts                                                 \\
Integration                       & The capacity of the standard model to use multiples terminology and links its to standard one                     \\
Implementability                  & The stability of the models, the community, the cost of adoption                                                  \\
Understandability                 & The ease of the standard model to be understood                                                           	      \\
Simplicity                        & The ease of querying the standard model - the model should contains the minimum of concepts and relationship    \\\botrule 
\end{tabular}
\label{table:quality}
\end{table*}
\normalsize

%% structural mapping
%      Ajouter schema : MIMIC-OMOP equivalence.png

The table \ref{table:dispatch} shows the structural mapping, i.e. where the 
information goes and links between the MIMIC tables and the MIMICIII-OMOP tables go.
The largest relationship is the measuring table with 366272371 rows.
Since OMOP is a conceptual model, the same type of data goes into the same table. 
The best example can be the measurement table which is field by 4 source tables. 
That's because all numerical data should go to that table.
All MIMIC domains are linked to the OMOP domain. 
Structural mapping was not a problem for our work.

\begin{table*}[t]
%\tbl{MIMIC to OMOP data flows}{
\caption{MIMIC to OMOP data flows}
\begin{tabular}{@{}lll@{}}\toprule
OMOP tables           & Number of rows & MIMIC tables                                             \\\colrule
PERSONS               & 46520          & patients, admissions                                     \\
DEATH                 & 14849          & patients, admissions                                     \\
VISIT\_OCCURRENCE     & 58976          & admissions                                               \\
VISIT\_DETAIL         & 271808         & transfers, service                                       \\
MEASUREMENT           & 366272371      & chartevents, labevents, microbiologyevents, outputevents \\
OBSERVATION           & 6721040        & admissions, chartevents, datetimevvents, drgcodes        \\
DRUG\_EXPOSURE        & 24934758       & prescriptions, inputevents\_cv, inputevents\_mv          \\
PROCEDURE\_OCCURRENCE & 1063525        & cptevents, procedureevents\_mv, procedure\_icd           \\
CONDITION\_OCCURRENCE & 716595         & admissions, diagnosis\_icd                               \\
NOTE                  & 2082294        & notevents                                                \\
NOTE\_NLP             & 16350855       & noteevents                                               \\
COHORT\_ATTRIBUTE     & 2628838        & callout                                                  \\
CARE\_SITE            & 93             & transfers, service                                       \\
PROVIDER              & 7567           & caregivers                                               \\
OBSERVATION\_PERIOD   & 58976          & patients, admissions                                     \\
SPECIMEN              & 39874171       & chartevents, labevents, microbiologyevents               \\\botrule
\end{tabular}
\label{table:dispatch}
\end{table*}
 

                                                                   
%% Semantic  mapping
The table \ref{table:statistics} presents the basic characterization of the 
MIMIC-OMOP population in relation to the MIMIC and assesses the overall quality of 
our semantic mapping.

\begin{table*}[t]
%\tbl{Baseline characteristics MIMIC versus OMOP}{
\caption{Baseline characteristics MIMIC versus OMOP}
\begin{tabular}{@{}lll@{}}\toprule
items                                  & MIMIC                       & OMOP                               \\\colrule
Persons (Number)                       & 46.520                      & 46.520                             \\
Admissions (Number)                    & 58.976                      & 58.976                             \\
Icustays (Number)                      & 71.576                      & 61.532                             \\
Gender, Female (Number, \%)            & 20.399                      & 20.399 (43 \%)                     \\
Age (Mean)                             & 64 years, 4 months          & 64 ans, 4 months                   \\
0-5                                    & 8110                        & 8110                               \\
6-15                                   & 1                           & 1                                  \\
16-25                                  & 1434                        & 1434                               \\
26-45                                  & 5962                        & 5962                               \\
46-65                                  & 17375                       & 17375                              \\
66-80                                  & 15793                       & 15793                              \\
\textgreater{}80                       & 10301                       & 10301                              \\
Emergency                              & 42071                       & 42071                              \\
Elective                               & 7706                        & 7706                               \\
Surgical patients                      & 19246                       & 19246                              \\
Length of stay, hospital (median)      & 6.46 (Q1-Q3 : 3.74 -11.79)  & 6.59 (Q1-Q3 : 3.84 - 11.88)        \\
Length of stay, ICU (median)           & 2.09 (Q1-Q3 : 1.10 - 4.48)  & 1.87 (Q1-Q3 : 0.95 - 3.87)         \\
Mortality, ICU (Number, \%)            & 5814 (9\%)                  & 5815 (9\%)                         \\
Mortality, hospital (Number, \%)       & 4511 (7\%)                  & 4559 (6\%)                         \\
Lab measurements per admissions (mean) & 478                         & 678                                \\
Procedures per admissions (mean)       & 4.6                         & 4.6                                \\
Drugs per admissions (mean)            & 82.8                        & 82.8                               \\
Exit dignosis per admissions (mean)    & 11.0                        & 11.0                               \\\botrule
\end{tabular}
\label{table:statistics}
\end{table*}

Fortunately most statistics remain similar between the two versions. 
There are still some differences. 
The table \ref{table:statistics} MIMIC contains 61,532 intensive care stays while 
OMOP contains 71,576 intensive care stays. This represents a 16\% increase in 
stays due to our ELT methodology as explained in the methods.
                    
This table shows that the number of laboratory measurements 
per admission is increased. This is because the laboratory data from MIMIC 
chartervents have been extracted and treated as a laboratory.

%% Loss of datas                                        
We tried to estimate the percentage of records loaded from the source database 
at MIMIC-OMOP. We estimate the percentage of columns and rows lost in 
the process as other studies have done \cite{omop-nashville}.
                    
According to the tables, 40\% to 80\% of the columns in the sources that do not 
correspond to OMOP have been deleted. The exact columns removed are provided 
on the article github. Almost all the deleted columns were redundant with others 
or provided derived information. The main concern is the loss of some timestamps. 
For example, the MIMIC chartevents tables provide the storetime and charttime columns, 
but OMOP provides only one location to store timestamp. Thus, MIMIC storetime 
column was eliminated during ELT. As mentioned in the methods the error lines 
have been deleted in the process (marked with a status column in the MIMIC tables 
inputevents\_mv, chartevents, procedureevents\_mv, note).
The following table \ref{table:lostrows} shows the number of lines with deleted 
errors.

\begin{table*}[t]
%\tbl{Row level Data lost}{
\caption{Row level Data lost}{
\begin{tabular}{@{}ll@{}}\toprule
Relations           & Error Percentage \\\colrule
inputevents\_mv     & 10,00\%          \\
chartevents         & 0.04\%           \\
procedureevents\_mv & 3,00\%           \\
Note                & 0.04\%           \\\botrule
\end{tabular}}
\label{table:lostrows}
\end{table*}

%% conceptual mapping coverage

This table \ref{table:mapping} shows the results of automatic and manual mapping. 
The unmapped concepts are the concept id = 0 (no mapping concept). 
To improve this mapping, we need collaborative work. Terminology mapping was 
evaluated by a physician. The value zero for concept\_id can appear in very 
different cases. In the first case, the local concept has no equivalent in the 
standard concept set. In the second case, it has not yet been mapped and may 
have a standard equivalent. In the third case, the value is missing and cannot 
be mapped. In our opinion, although not all of these cases can be used for 
standard queries, they should have a different concept identifier in order to be 
treated differently (not only concept\_id = 0). Some of the domains\_id do not 
match the table name, it makes sense because the observation domain can be 
measurement table and vice versa.
Often we have mapped many source concepts to a standard concept\_id. This is 
because MIMIC provides a large number of equivalent concepts. For example, 
for body temperature, MIMIC provides 11 distinct concepts (Temperature F, 
Temperature C (calc), Temp Skin [C], Temperature Fahren- heit, Temp Axillary [F], 
Temperature C, Temperature F (calc), Temperature Celsius, Temp Rectal [F], 
Temp Rectal, Blood Temperature CCO (C)). Our mapping links all this to a single 
concept called temperature. All units have been converted to Celcius.

\begin{table*}[t]
%\tbl{Terminology Mapping coverage}
\caption{Terminology Mapping coverage}
\begin{tabular}{@{}lllll@{}}\toprule
Omop tables (domain)   & Total\_records & \% Mapped\_records  & Total\_concepts\_source & \% Mapped\_concepts\_source  \\\colrule
PERSONS                & 93040          & 100,00\%            & 43                      & 100,00\%                     \\
VISIT\_OCCURRENCE      & 58976          & 100,00\%            & 34                      & 100,00\%                     \\
VISIT\_DETAIL          & 396930         & 100,00\%            & 28                      & 100,00\%                     \\
MEASUREMENT            &                &                     &                         &                              \\
OBSERVATION            &                &                     &                         &                              \\
DRUG\_EXPOSURE         & 24934751       & 37,00\%             & 7410                    & 53,00\%                      \\
PROCEDURE\_OCCURRENCE  & 1063525        & 99,00\%             & 2218                    & 98,00\%                      \\
CONDITION\_OCCURRENCE  & 716595         & 92,00\%             & 6984                    & 95,00\%                      \\
CARE\_SITE             & 144            & 100,00\%            & 58                      & 100,00\%                     \\
SPECIMEN               & 39874171       & 70,00\%             & 92                      & 77,00\%                      \\\botrule
\end{tabular}
\label{table:mapping}
\end{table*}

%% Flexibility  
OMOP had a 100\% match of the constraints and relationships of the data models
and is a flexibility is high. 
Two important tables are provided with OMOP models to match the relationships : 
concept\_relationship and fact\_relationship. It is used to represent the 
relationship between the data. We used it to bind the drugs into a solution, 
for microbiology / antibiograms and for visit\_detail and caresite links. 
The following SQL query~\ref{lst:original} shows how a microorganism is linked to its susceptibility 
test by a fact\_relationship.

\begin{lstlisting}[language=sql,basicstyle=\scriptsize,caption=Original table microbiology SQL query,label={lst:original}]
SELECT measurement_source_value
, value_as_concept_id
, concept_name
FROM measurement
JOIN concept resistance 
     ON value_as_concept_id = concept_id
JOIN fact_relationship 
     ON measurement_id =  fact_id_2
JOIN
(
   SELECT measurement_id AS id_is_staph
   FROM measurement m
   WHERE TRUE 
   AND measurement_type_concept_id = 2000000007        			
      -- 'Labs - Culture Organisms'
   AND value_as_concept_id = 4149419                     			
      -- 'Staph aureus coag +' 
   AND measurement_concept_id = 46235217               			
      -- 'Bacteria identified in Blood product 
         unit.autologous by Culture'
) staph ON id_is_staph = fact_id_1;
WHERE TRUE
AND  measurement_type_concept_id = 2000000008        			        
  -- concept.concept_name = 'Labs - Culture Sensitivity'
\end{lstlisting}

\begin{lstlisting}[language=sql,basicstyle=\scriptsize,caption=Optimized table microbiology SQL query,label={lst:optimized}]
SELECT measurement_source_value
, value_as_concept_id
, concept_name
FROM measurement
JOIN concept resistance 
     ON value_as_concept_id = concept_id
JOIN fact_relationship 
     ON measurement_id =  fact_id_2
JOIN
(
   SELECT measurement_id AS id_is_staph
   FROM measurement m
   WHERE TRUE 
   AND measurement_type_concept_id = 2000000007        			
      -- 'Labs - Culture Organisms'
   AND value_as_concept_id = 4149419                     			
      -- 'Staph aureus coag +' 
   AND measurement_concept_id = 46235217               			
      -- 'Bacteria identified in Blood product 
         unit.autologous by Culture'
) staph ON id_is_staph = fact_id_1;
WHERE TRUE
AND  measurement_type_concept_id = 2000000008        			        
  -- concept.concept_name = 'Labs - Culture Sensitivity'
\end{lstlisting}

%% Integration
OMOP's terminology coverage has already been rated as excellent \cite{omop-vs-pcornet}. 
We used OMOP mapping for NDC-RxNorm, ICD9-SNOMED, CPT4-SNOMED. 
This was really useful to integreate MIMIC database because it provides a lot 
of non-standard terminology already mapped by the OMOP community. 
We tried to evaluate this automatic OMOP mapping. We check 100 elements for each 
mapping used (NDC, ICD9 and CPT4). CIM9 and CPT4 are correctly mapped to SNOMED 
(100\%). But only 85\% of NDCs are linked to a correct RxNorm code. 
Partly because of an incorrect NDC code (from MIMIC), partly because only 78\% 
of NDC codes are mapped to Rxnorm. Moreover, even if this does not seem to have 
affected our ELT we know that not all ICD-9-CM codes can have a one-to-one match 
with SNOMED, some are one to several (28\%) \cite{snomed-icd9}
 
%% Implementability
OMOP has been available for 9 years. Its models and concepts provided are 
license free, the community is large and has been very helpful. Full versions 
are generally published annually and are not backwards compatible. 
Minor versions are not guaranteed to be backwards compatible, although an effort 
is made to ensure that current requests will not break. Micro-versions are 
published irregularly and often, and contain small corrections or changes 
that are backward compatible with the latest minor version \cite{omop-cdm}

% TODO: forum centric + github + themis -> confusing


\subsection{Contribution}

\emph{Denormalized derived} tables improve calculation costs and SQL query verbosity. 
In addition, the resulting tables are much more human readable with the concept 
label directly in table and greatly reduces joins. Therefore, a little 
denormalization greatly improves the data scientist's experience and the simplicity
 by adding some redundancy in the data while not interrupting existing SQL queries. 
Moreover, these normalized views are backward compatible and remain 
standardized allowing the creation of multicentric algorithms.

\emph{Materialized derived views} from microbiologyevents and icustays simplify 
the experience for scientists. The community should do more.
                    
As indicated in the methods section, we have provided many \emph{derived values}. 
Again, the community is welcome to evaluate and improve them.   


\subsection{Analytics}
The French Hospital of Paris (AP-HP) organized a datathon with MIMIC-OMOP. 
25 teams, 160 participants had 48 hours to undertake a clinical project using 
the database MIMIC-OMOP through 15000 requests with a maximum duration of
one minute. They had the opportunity to create mixed teams: clinicians brought 
the issues that required data mining, as well as their data expertise; 
data scientists judged the technical feasibility and finally implemented the 
various analyses needed. Writing standard queries (i.e. with standard concepts) 
requires knowing the organization of relational models (SQL) and also mastering 
the graphical nature of certain terminologies such as SNOMED-CT in order to 
capture all potential codes that might be related to the one analysts think of 
first. This complexity is inherent in terminology complexity and the closure 
table \ref{closure-table}. It is therefore not specific to OMOP or MIMIC-OMOP. 
Overall the teams found MIMIC-OMOP easy to learn.
All teams managed to produce results at the end of the datathon.
