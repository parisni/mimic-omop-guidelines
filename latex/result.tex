\subsection{Transformation}
% effectiveness of the transformation

The MIMIC to OMOP conversion was done by two developers (one data engineer and
one intensivist) in an estimate amount of 500 hours. This includes the ETL, the
git documentation, the concept mapping, the contributions and the unit tests.
The ETL (including unit tests, and generation of the ready to load archive) on
the 100 patient subset takes five minutes and allows fast cycles of
developments. On the full MIMIC dataset the ETL lasts 3 hours. 
The resulting csv archive is slightly the same size than the original one, and
this is also the same once instanced in PGSQL and indexed.


In order to evaluate how well transformed is the data we first adopt the data
quality evaluation grid (\ref{table:quality}) developed by Khan and Al
\cite{khan-quality} which is commonly used as a reference \cite{moody-quality}.

- size of MIMIC OMOP, row number for the bigest relation (measurement)

  For the prescritions MIMIC table 75\% (a verifier) of drugs had a gsn code. The conept\_relationship table provide mapping between gsn and RxNorm classsifications. To improve the mapping we then proceeded to a manual mapping

The OMOP-CDM contains 37 data tables. We populated 19 tables.
From MIMIC we create a standardized model called MIMIC-OMOP.

Quality evaluation criteria
%===========================
1)
Several articles tried to evaluate CDM quality (8, 9).
The criterias developped by Khan and Al, which referenced Moody and Shanks (10) metrics were adapted to our study.
Our study doesn't want to evaluate the quality of CDM. But we adapt these criterias to assess our ETL work.

% Please add the following required packages to your document preamble:
% \usepackage[normalem]{ulem}
% \useunder{\uline}{\ul}{}
% Please add the following required packages to your document preamble:
% \usepackage[normalem]{ulem}
% \useunder{\uline}{\ul}{}
\begin{table*}[t]
\tbl{Data Transformation Quality Evaluation Metrics}{%
\begin{tabular}{@{}ll@{}}\toprule
Data Model Dimension              & Descriptions                                                                                                      \\\colrule
Completeness - semantic mapping   & Domain coverage : coverage of sources domains that are accommodated by the standard OMOP model                    \\
Completeness - structural mapping & Data coverage : coverage of sources data concepts that mapped to standard OMOP concept                           \\
Integrity                         & "Meaningful data relationships and constraints that uphold th eintent of the data-s original purpose" Khan and Al \\
Flexibility                       & The ease to expand the standard model for new datatypes, concepts                                                 \\
Integration                       & The capacity of the standard model to use multiples terminology and links its to standard one                     \\
Implementability                  & The stability of the models, the community, the cost of adoption                                                  \\
Understandability                 & The ease of the standard model to be understood                                                           	      \\
Simplicity                        & The ease of querying the standard model - the model should contains the minimum of concepts and relationship    \\\botrule 
\end{tabular}}
\label{table:quality}
\end{table*}

Understandability and simplicity will be evaluated in the analytics parts, in real life application.

2) 
During the all ETL process we created a lot of unit tests thanks to pgTap library. All are available on our github. All the test passed.

3)

Compleness - semantic mapping 
%=============================

The table \ref{table:dispatch} shows where the informations goes and links
between MIMIC tables and OMOP tables.  Since OMOP is a conceptual model, a same
type of data goes in the same table. The best example may be the measurement
table which is field by 4 source tables. Is is because of all the numerics
datas should go to this table.

\begin{table*}[t]
\tbl{MIMIC to OMOP data flows}{
\begin{tabular}{@{}lll@{}}\toprule
OMOP tables           & Number of rows & MIMIC tables                                             \\\colrule
PERSONS               & 46520          & patients, admissions                                     \\
DEATH                 & 14849          & patients, admissions                                     \\
VISIT\_OCCURRENCE     & 58976          & admissions                                               \\
VISIT\_DETAIL         & 271808         & transfers, service                                       \\
MEASUREMENT           & 366272371      & chartevents, labevents, microbiologyevents, outputevents \\
OBSERVATION           & 6721040        & admissions, chartevents, datetimevvents, drgcodes        \\
DRUG\_EXPOSURE        & 24934758       & prescriptions, inputevents\_cv, inputevents\_mv          \\
PROCEDURE\_OCCURRENCE & 1063525        & cptevents, procedureevents\_mv, procedure\_icd           \\
CONDITION\_OCCURRENCE & 716595         & admissions, diagnosis\_icd                               \\
NOTE                  & 2082294        & notevents                                                \\
NOTE\_NLP             & 16350855       & noteevents                                               \\
COHORT\_ATTRIBUTE     & 2628838        & callout                                                  \\
CARE\_SITE            & 93             & transfers, service                                       \\
PROVIDER              & 7567           & caregivers                                               \\
OBSERVATION\_PERIOD   & 58976          & patients, admissions                                     \\
SPECIMEN              & 39874171       & chartevents, labevents, microbiologyevents               \\\botrule
\end{tabular}}
\label{table:dispatch}
\end{table*}

Ajouter schema : MIMIC-OMOP\_equivalence.png

As shown, all the MIMIC domain are linked to proper OMOP domain. 
The semantic mapping was not a problem for our work.

Completeness - structural mapping 
%===============================

Baseline characteristics : comparison MIMIC / MIMIC OMOP (basic statistics)
%*******************************************************************************

The following table lists the baseline characterization of the population of
OMOP compared with MIMIC.

\begin{table*}[t]
\tbl{Baseline characteristics MIMIC versus OMOP}{
\begin{tabular}{@{}lll@{}}\toprule
items                                  & MIMIC                       & OMOP                               \\\colrule
Persons (Number)                       & 46.520                      & 46.520                             \\
Admissions (Number)                    & 58.976                      & 58.976                             \\
Icustays (Number)                      & 71.576                      & 61.532                             \\
Gender, Female (Number, \%)            & 20.399                      & 20.399 (43 \%)                     \\
Age (Mean)                             & 64 years, 4 months          & 64 ans, 4 months                   \\
0-5                                    & 8110                        & 8110                               \\
6-15                                   & 1                           & 1                                  \\
16-25                                  & 1434                        & 1434                               \\
26-45                                  & 5962                        & 5962                               \\
46-65                                  & 17375                       & 17375                              \\
66-80                                  & 15793                       & 15793                              \\
\textgreater{}80                       & 10301                       & 10301                              \\
Emergency                              & 42071                       & 42071                              \\
Elective                               & 7706                        & 7706                               \\
Surgical patients                      & 19246                       & 19246                              \\
Length of stay, hospital (median)      & 6.46 (Q1-Q3 : 3.74 -11.79)  & 6.59 (Q1-Q3 : 3.84 - 11.88)        \\
Length of stay, ICU (median)           & 2.09 (Q1-Q3 : 1.10 - 4.48)  & 1.87 (Q1-Q3 : 0.95 - 3.87)         \\
Mortality, ICU (Number, \%)            & 5814 (9\%)                  & 5815 (9\%)                         \\
Mortality, hospital (Number, \%)       & 4511 (7\%)                  & 4559 (6\%)                         \\
Lab measurements per admissions (mean) & 478                         & 678                                \\
Procedures per admissions (mean)       & 4.6                         & 4.6                                \\
Drugs per admissions (mean)            & 82.8                        & 82.8                               \\
Exit dignosis per admissions (mean)    & 11.0                        & 11.0                               \\\botrule
\end{tabular}}
\label{table:statistics}
\end{table*}

Hopefully most statistics remains similar between two versions. Still some
differences exists. Table \ref{table:statistics} MIMIC contains 61.532 stays in
ICU whereas OMOP contains 71.576 ICU stays. That is a 16\% increase in stays
due to our ETL methodology as explained in the methods.

The table \ref{table:statistics} shows the number of laboratory measurement per
admissions is increased. This is because the laboratory data from MIMIC
chartevents has been extracted and treated as laboratory. All the code to
created this statistics are provided here (cf extra : basic\_statistics.sql).

Loss of datas
%*************

We tried to evaluate the percentage of loaded records from the source database
to OMOP. We evaluate the percentage of columns and rows lost in the process as
done other studies \cite{omop-nashville}

% column loss
Depending on tables 40\% to 80\% of sources columns which do not fit to OMOP
where deleted.  The exact removed columns are provided in the appendix (cf
extras) Almost all the removed columns are redundant with others or provide
derived informations.  The main concern are some lost timestamps. For example
the MIMIC chartevents tables provide the storetime and charttime columns but
OMOP only provide one slot for timestamp to stored. Thus storetime was deleted
during the ETL.
% row loss
The erroneous rows \ref{table:lostrows} were deleted in the process (marked
with a status column in MIMIC tables inputevents\_mv, chartevents,
procedureevents\_mv, note). As MIMIC team told us that they will remove it in
the next release because this data are poor quality we decided to do the same. 
The following table shows the number of rows with errors.

\begin{table*}[t]
\tbl{Row level Data lost}{
\begin{tabular}{@{}ll@{}}\toprule
Relations           & Error Percentage \\\colrule
inputevents\_mv     & 10,00\%          \\
chartevents         & 0.04\%           \\
procedureevents\_mv & 3,00\%           \\
Note                & 0.04\%           \\\botrule
\end{tabular}}
\label{table:lostrows}
\end{table*}

terminology mapping coverage
%****************************

\begin{table*}[t]
\tbl{Terminology Mapping coverage}{
\begin{tabular}{@{}lllll@{}}\toprule
Omop tables (domain)   & Total\_records & \% Mapped\_records  & Total\_concepts\_source & \% Mapped\_concepts\_source  \\\colrule
PERSONS                & 93040          & 100,00\%            & 43                      & 100,00\%                     \\
VISIT\_OCCURRENCE      & 58976          & 100,00\%            & 34                      & 100,00\%                     \\
VISIT\_DETAIL          & 396930         & 100,00\%            & 28                      & 100,00\%                     \\
MEASUREMENT            &                &                     &                         &                              \\
OBSERVATION            &                &                     &                         &                              \\
DRUG\_EXPOSURE         & 24934751       & 37,00\%             & 7410                    & 53,00\%                      \\
PROCEDURE\_OCCURRENCE  & 1063525        & 99,00\%             & 2218                    & 98,00\%                      \\
CONDITION\_OCCURRENCE  & 716595         & 92,00\%             & 6984                    & 95,00\%                      \\
CARE\_SITE             & 144            & 100,00\%            & 58                      & 100,00\%                     \\
SPECIMEN               & 39874171       & 70,00\%             & 92                      & 77,00\%                      \\\botrule
\end{tabular}}
\end{table*}

These results include automatic and manual mapping.

The unmapped concept are the concept\_id = 0 (No mapping concept). To improve
this mapping we need collaborative work. We provide our csv mapping files on
our github.
The terminology mapping has been evaluated by a physician. 
% need to identify missing values
The zero value for concept\_id may appear in very different cases. First case
the local concept has no equivalent in the standard set of concept. Second case
it has not been yet been mapped and may have an standard equivalent. Third case
the value is missing and cannot be mapped. In our opinion while all those cases
cannot be used for standard queries, they should have a different concept\_id
in order to be addressed differently.

- \% of domain\_id not in adequation with table name 
	- some are logical because observation domain may be measurement table and vice verca

- we have mapped  many source concept to one standard concept\_id. This is because MIMIC provide a lots of equivalent free text concepts.
  For example for the body temperature MIMIC provide 11 distinct concept (Temperature F, Temperature C (calc), Temp Skin [C], Temperature Fahrenheit, Temp Axillary [F], Temperature C, Temperature F (calc), Temperature Celsius, Temp Rectal [F], Temp Rectal, Blood Temperature CCO (C)). Our mapping links all of it to one single concept called temperature. All the units have been converted to celcius.
  TODO: give example of generalisation (admission\_location\_to\_concept)

Flexibility  
===========
OMOP had a 100\% match of the data models constraints and relationship.
Two important tables are provided with the OMOP models to  match relationship : concept\_relationship and fact\_relationship.
The fact\_relationship table which is a important part of the OMOP CDM. It is used to represent the relationship between data.
We used to link drugs in a solution, for microbiology / antibiograms and for visit\_detail and caresite.
The SQL following query shows how a microorganism is linked to its antibiogram thanks to fact\_relationship

%SELECT measurement_source_value, value_as_concept_id, concept_name
%FROM measurement
%JOIN concept resistance ON value_as_concept_id = concept_id
%JOIN fact_relationship ON measurement_id =  fact_id_2
%JOIN
%(
%	SELECT measurement_id AS id_is_staph
%	FROM measurement m
%	WHERE measurement_type_concept_id = 2000000007        			-- concept.concept_name = 'Labs - Culture Organisms'
%	AND value_as_concept_id = 4149419                     			-- concept.concept_name = 'staph aureus coag +'
%	AND measurement_concept_id = 46235217               			-- concept.concept_name = 'Bacteria identified in Blood product unit.autologous by Culture';
%
%) staph ON id_is_staph = fact_id_1;
%WHERE measurement_type_concept_id = 2000000008        			        -- concept.concept_name = 'Labs - Culture Sensitivity'


Integration
===========

OMOP Terminology coverage has been previously evaluated as excellent
\cite{omop-vs-pcornet}. We used the OMOP mapping for NDC-RxNorm, ICD9-SNOMED,
CPT4-SNOMED. It was really helpful because MIMIC provides lots of non standard
terminology already mapped by OMOP community
We tried to evaluated this OMOP mapping.
We check 100 items for each mapping used (NDC, ICD9 and CPT4). ICD9 and CPT4 are correcly mapped to SNOMED. But only 85\% of NDC are
linked to a correct RxNorm code. In part due to incorrect NDC code (from MIMIC), in part because only 78\% of NDC codes are mapped to Rxnorm.

But the OMOP common standard vocabulary, SNOMED-CT, did not cover all ICD-9-CM
codes (95\%). Moreover, not all ICD-9-CM codes can have one-to-one mapping to
SNOMED, some are one-to-many (28\%)\cite{snomed-icd9}
 
Implementability
===============
- OMOP available since 9 years
- this models and its provided concepts are licence free
- the community is large and was very helpful.
- Full versions (V6, 7 etc.) are usually released each year (1-Jan) and are not backwards compatible. 
Minor versions (V5.1, 5.2 etc.) are not guaranteed to be backwards compatible though an effort is made to make sure that current queries will not break. 
Micro versions (V5.1.1, V5.1.2 etc.) are released irregularly and often, and contain small hot fixes or backward compatible changes to the last minor version.
(7)
TODO: forum centric + github + themis -> confusing


Finally OHDSI provides ACHILLES as data quality tool for OMOP. It has been a
common practice to run the tests and use this as a quality evaluation in
numerous work \cite{achilles-papers}

Achilles for quality assessment
==============================
A many previous authors, we used Achilles software to evaluate the data
quality(4). It is open-source analytics software produced by OHDSI (6).  This
tool is used for data characterization, data quality assessment (Achilles
Heel), and the visualization of observational health data (6).  ACHILLES
calculates summary statistics and includes a unique function for checking data
quality, named Achilles Heel. 
Other team used this tool to practice data quality assess(4).
Achilles Heel issued x errors and y warnings.

- 18h 50k patients: this testifies the model needs structural optimisations
- difficultÃ© pour ajoute fr. 
- extension achilles how to ?
- comparison with other paper about error/warnings. (Korean Yoon 36->28 errors)
TODO: minimize achille errors  (12->? errors)


\subsection{Analytics}

- French Paris hospital organized a datathon with MIMIC-OMOP
25 teams, 160 participants had 48 hours to undertake a clinical project using the OMOP MIMIC database thought 15000 requests. They had the opportunity to create mixed teams : clinicians brought the questions which need data mining, along with their expertise of the data ; data scientists judged the technical feasibility and eventually implement the various analysis needed
This datahon had tested OMOP model in real statistical condition. A datathon was organised in collaboration with the MIT.(3)

- AP-HP calculation clusters, able to access to the data pre-loaded in Jupyter environments, where will be installed the most popular tools and libraries in R and Python, with Hadoop Spark

schema big data platform

MIMIC-OMOP dataset was 10 GO sized as ORC format. On the other side the same
dataset is sized 400 GO on a PGSQL instance. Generating the indexes
ORC automatically generates indexing. However these are much light than the
PGSQL btree indexes specified by the OMOP DDL.

Writing standard queries (ie: with standard concepts) need to be familiar with
the concept\_relationship design and also master graph nature of some
terminology such SNOMED-CT in order to grab all potential codes that might be
related to the one analysts think of primarily. This complexity is inherent of
terminology complexity and the closure table \ref{closure-table} design handle
perfectly.

\subsection{Contribution}

The \emph{denormalized derived} tables appears to improves the computations
costs and the verbosity of the SQL queries. In addition the resulting tables
are much more human readily with the label of the concepts directly in the fact
table. Hence a bit of denormalization improves greatly the experience of the
data scientist by adding some redundancy in the data while not breaking
existing SQL queries. The drawback is it would make it more tricky to update
and keep the dataset consistent - which is non applicable because OMOP is
generally a static dataset.
The \emph{microbiology derived} table simplifies the experience for
data-scientists.

We provided many derived values. Community is welcome to improve it
- From noteevents : weight, height, LVEF
- From measurement : SOFA, IGSII, F/P, corrected Ca / K, BMI, corrected osmolarity

We also provided materialized views with denormalized structures : microbiology tables
This is a more ICU centric data structures that may help for analytics.

%others
%######

- ethnicity\_concept\_id : only two strange concept\_name Hispanic or non\_Hispanic
